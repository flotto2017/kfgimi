<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Å‡∏°‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏Ñ‡∏¥‡∏î‡πÄ‡∏£‡πá‡∏ß (Speed Math) + Gemini AI</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Markdown Parser (Marked) for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;800&display=swap');
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f3f4f6;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .anim-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 10px;
        }
        /* AI Typing Effect */
        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-start infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,env">
        const { useState, useEffect, useRef } = React;
        
        // --- Gemini API Helper ---
        const callGeminiAPI = async (prompt) => {
            const apiKey = ""; // System will provide this
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            const delays = [1000, 2000, 4000, 8000, 16000];
            
            for (let i = 0; i < delays.length + 1; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI ‡∏ô‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö";
                } catch (error) {
                    if (i === delays.length) {
                        console.error("Gemini API failed after retries:", error);
                        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö AI ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß";
                    }
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        };

        // --- Firebase Initialization ---
        let firebaseApp, auth, db;
        let appId = 'default-app';
        let isFirebaseReady = false;

        try {
            if (typeof __firebase_config !== 'undefined') {
                const config = JSON.parse(__firebase_config);
                if (typeof firebase !== 'undefined') {
                    if (!firebase.apps.length) {
                        firebaseApp = firebase.initializeApp(config);
                    } else {
                        firebaseApp = firebase.app();
                    }
                    auth = firebase.auth();
                    db = firebase.firestore();
                    if (typeof __app_id !== 'undefined') appId = __app_id;
                    isFirebaseReady = true;
                } else {
                    console.error("Firebase SDK not loaded properly.");
                }
            } else {
                console.warn("No Firebase config found. Online mode will be disabled.");
            }
        } catch (e) {
            console.error("Firebase init error:", e);
        }

        // --- Helper Functions ---
        const generateQuestion = () => {
            const ops = ['+', '-', '*'];
            const op = ops[Math.floor(Math.random() * ops.length)];
            let a, b;

            if (op === '*') {
                a = Math.floor(Math.random() * 12) + 2;
                b = Math.floor(Math.random() * 9) + 2;
            } else {
                a = Math.floor(Math.random() * 50) + 1;
                b = Math.floor(Math.random() * 50) + 1;
            }

            if (op === '-' && a < b) [a, b] = [b, a];

            const answer = eval(`${a} ${op} ${b}`);
            return { a, b, op, answer, id: Date.now() };
        };

        const Timer = ({ duration, onTimeUp, active }) => {
            const [timeLeft, setTimeLeft] = useState(duration);

            useEffect(() => {
                if (!active) return;
                if (timeLeft <= 0) {
                    onTimeUp();
                    return;
                }
                const timer = setInterval(() => {
                    setTimeLeft(prev => prev - 1);
                }, 1000);
                return () => clearInterval(timer);
            }, [timeLeft, active]);

            return (
                <div className={`text-2xl font-bold ${timeLeft < 10 ? 'text-red-500' : 'text-blue-600'}`}>
                    <i className="fa-regular fa-clock mr-2"></i> {timeLeft}s
                </div>
            );
        };

        // --- Components ---

        const LoginScreen = ({ onLogin, onManualLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                // --- Backdoor for Admin/1234 (Requested by user) ---
                if (username === 'admin' && password === '1234') {
                    // Simulate a delay
                    setTimeout(() => {
                        if (onManualLogin) {
                             onManualLogin({
                                 uid: 'admin-demo-uid',
                                 displayName: 'Admin (Demo)',
                                 email: 'admin@speedmath.app',
                                 isAnonymous: false,
                                 updateProfile: () => Promise.resolve()
                             });
                        }
                    }, 500);
                    return;
                }

                if (!isFirebaseReady) {
                    setError("‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase");
                    setLoading(false);
                    return;
                }

                const email = `${username}@speedmath.app`;

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    console.error(err);
                    if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-email') {
                        setError("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ");
                    } else if (err.code === 'auth/wrong-password') {
                        setError("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                    } else {
                        setError("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
                    }
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop">
                    <div className="glass-panel p-8 rounded-3xl w-full max-w-sm">
                        <div className="text-center mb-6">
                            <div className="text-5xl text-blue-500 mb-2"><i className="fa-solid fa-lock"></i></div>
                            <h2 className="text-2xl font-bold text-gray-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                            <p className="text-xs text-gray-400 mt-1">Demo: admin / 1234 ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ Admin ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡πâ</p>
                        </div>

                        {error && (
                            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mb-4 text-sm rounded">
                                {error}
                            </div>
                        )}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-2">Username</label>
                                <input 
                                    type="text" 
                                    value={username} 
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full p-3 rounded-xl border border-gray-300 focus:border-blue-500 outline-none transition"
                                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-2">Password</label>
                                <input 
                                    type="password" 
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 rounded-xl border border-gray-300 focus:border-blue-500 outline-none transition"
                                    placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"
                                    required
                                />
                            </div>
                            <button 
                                type="submit" 
                                disabled={loading}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transform transition hover:scale-105"
                            >
                                {loading ? <i className="fa-solid fa-circle-notch fa-spin"></i> : '‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const Leaderboard = ({ onBack, currentUser }) => {
            const [scores, setScores] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (!isFirebaseReady) return;

                const fetchScores = async () => {
                    try {
                        const snapshot = await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('scores').get();
                        let loadedScores = snapshot.docs.map(doc => doc.data());
                        loadedScores.sort((a, b) => b.score - a.score);
                        setScores(loadedScores.slice(0, 20));
                        setLoading(false);
                    } catch (err) {
                        console.error("Error fetching leaderboard:", err);
                        setLoading(false);
                    }
                };
                fetchScores();
            }, []);

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop">
                    <div className="glass-panel p-6 rounded-3xl w-full max-w-md relative h-[80vh] flex flex-col">
                        <button onClick={onBack} className="absolute top-4 left-4 text-gray-400 hover:text-gray-600 z-10">
                            <i className="fa-solid fa-arrow-left fa-xl"></i>
                        </button>
                        <h2 className="text-3xl font-bold text-center text-yellow-500 mb-2 mt-2">
                            <i className="fa-solid fa-trophy mr-2"></i>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°
                        </h2>
                        
                        <div className="flex-1 overflow-y-auto custom-scroll mt-4 pr-2">
                            {loading ? (
                                <div className="text-center text-gray-400 mt-10">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                            ) : scores.length === 0 ? (
                                <div className="text-center text-gray-400 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                            ) : (
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="text-gray-400 text-sm border-b border-gray-200">
                                            <th className="py-2 px-2 font-light">#</th>
                                            <th className="py-2 px-2 font-light">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th>
                                            <th className="py-2 px-2 font-light text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {scores.map((s, index) => {
                                            const isMe = currentUser && s.username === currentUser.displayName;
                                            return (
                                                <tr key={index} className={`border-b border-gray-100 last:border-0 ${isMe ? 'bg-yellow-50' : ''}`}>
                                                    <td className="py-3 px-2 font-bold text-gray-500">
                                                        {index + 1 === 1 ? 'ü•á' : index + 1 === 2 ? 'ü•à' : index + 1 === 3 ? 'ü•â' : index + 1}
                                                    </td>
                                                    <td className={`py-3 px-2 font-semibold ${isMe ? 'text-blue-600' : 'text-gray-700'}`}>
                                                        {s.username} {isMe && '(‡∏Ñ‡∏∏‡∏ì)'}
                                                    </td>
                                                    <td className="py-3 px-2 text-right font-bold text-blue-500">
                                                        {s.score}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const MainMenu = ({ onStartSingle, onStartMulti, onShowLeaderboard, onLogout, canPlayOnline, username }) => {
            const [aiFact, setAiFact] = useState(null);
            const [loadingAi, setLoadingAi] = useState(false);

            const getMathFact = async () => {
                setLoadingAi(true);
                setAiFact(null);
                const prompt = "‡∏ö‡∏≠‡∏Å‡πÄ‡∏Å‡∏£‡πá‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏ó‡∏∂‡πà‡∏á 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô";
                const fact = await callGeminiAPI(prompt);
                setAiFact(fact);
                setLoadingAi(false);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop">
                    <div className="glass-panel p-8 rounded-3xl text-center max-w-md w-full border-b-4 border-blue-200 relative">
                        <div className="absolute top-4 right-4 flex flex-col items-end">
                             <span className="text-xs text-gray-400">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô:</span>
                             <span className="text-sm font-bold text-blue-600">{username}</span>
                        </div>

                        <div className="text-6xl mb-4 text-yellow-400 drop-shadow-md mt-6">
                            <i className="fa-solid fa-brain"></i>
                        </div>
                        <h1 className="text-4xl font-extrabold text-gray-800 mb-2">Speed Math</h1>
                        <p className="text-gray-500 mb-8">‡∏õ‡∏£‡∏∞‡∏•‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á ‡∏õ‡∏£‡∏∞‡∏•‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</p>

                        <button 
                            onClick={onStartSingle}
                            className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition hover:scale-105 mb-3 text-xl"
                        >
                            <i className="fa-solid fa-user mr-2"></i> ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                        </button>

                        <button 
                            onClick={onStartMulti}
                            disabled={!canPlayOnline}
                            className={`w-full font-bold py-4 px-6 rounded-2xl shadow-lg transform transition text-xl mb-3 ${
                                canPlayOnline 
                                ? 'bg-purple-500 hover:bg-purple-600 text-white hover:scale-105' 
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            }`}
                        >
                            <i className="fa-solid fa-users mr-2"></i> ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                        </button>

                        <button 
                            onClick={onShowLeaderboard}
                            className="w-full bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 px-6 rounded-2xl shadow-lg transform transition hover:scale-105 mb-3 text-lg"
                        >
                            <i className="fa-solid fa-trophy mr-2"></i> ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°
                        </button>

                        {/* Gemini Feature 1 */}
                        <div className="mt-4 mb-4">
                             <button 
                                onClick={getMathFact}
                                disabled={loadingAi}
                                className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transform transition hover:scale-105 flex items-center justify-center gap-2"
                            >
                                {loadingAi ? <i className="fa-solid fa-spinner fa-spin"></i> : <i className="fa-solid fa-sparkles"></i>}
                                <span>‡∏Ç‡∏≠‡πÄ‡∏Å‡∏£‡πá‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ AI</span>
                            </button>
                            {aiFact && (
                                <div className="mt-3 bg-indigo-50 p-3 rounded-lg text-sm text-indigo-800 border border-indigo-200 animate-pulse-slow">
                                    <strong className="block mb-1">‚ú® Gemini ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤:</strong>
                                    {aiFact}
                                </div>
                            )}
                        </div>

                        <button 
                            onClick={onLogout}
                            className="text-gray-400 hover:text-red-500 text-sm underline"
                        >
                            ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </div>
                </div>
            );
        };

        const Lobby = ({ onJoinRoom, onBack, currentUser }) => {
            const [roomId, setRoomId] = useState('');
            const [loading, setLoading] = useState(false);
            const playerName = currentUser?.displayName || currentUser?.email?.split('@')[0] || "Player";

            const handleCreate = async () => {
                setLoading(true);
                await onJoinRoom(playerName, null, 'create'); 
                setLoading(false);
            };

            const handleJoin = async () => {
                if (!roomId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á");
                setLoading(true);
                await onJoinRoom(playerName, roomId, 'join');
                setLoading(false);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop">
                    <div className="glass-panel p-8 rounded-3xl w-full max-w-md relative">
                        <button onClick={onBack} className="absolute top-4 left-4 text-gray-400 hover:text-gray-600">
                            <i className="fa-solid fa-arrow-left fa-xl"></i>
                        </button>
                        <h2 className="text-3xl font-bold text-center text-purple-600 mb-6">‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
                        
                        <div className="space-y-4">
                            <div className="text-center mb-4">
                                <span className="text-gray-500">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠: </span>
                                <span className="font-bold text-gray-800">{playerName}</span>
                            </div>

                            <div className="border-t border-gray-200 my-4 pt-4">
                                <button 
                                    onClick={handleCreate}
                                    disabled={loading}
                                    className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-md transition"
                                >
                                    {loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'}
                                </button>
                            </div>
                            
                            <div className="text-center text-gray-400 text-sm">- ‡∏´‡∏£‡∏∑‡∏≠ -</div>

                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={roomId} 
                                    onChange={(e) => setRoomId(e.target.value)}
                                    className="flex-1 p-3 rounded-xl border-2 border-purple-100 focus:border-purple-500 outline-none"
                                    placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô"
                                />
                                <button 
                                    onClick={handleJoin}
                                    disabled={loading}
                                    className="bg-purple-500 hover:bg-purple-600 text-white font-bold px-6 rounded-xl shadow-md transition"
                                >
                                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const GameScreen = ({ mode, question, score, opponentScore, onAnswer, onQuit, timeUp, roomId, status }) => {
            const [input, setInput] = useState('');
            const [feedback, setFeedback] = useState(null); 
            
            const inputRef = useRef(null);
            useEffect(() => { inputRef.current?.focus(); }, [question]);

            const handleSubmit = (e) => {
                e.preventDefault();
                const val = parseInt(input);
                if (isNaN(val)) return;

                if (val === question.answer) {
                    setFeedback('correct');
                    onAnswer(true);
                } else {
                    setFeedback('wrong');
                    onAnswer(false);
                }
                setInput('');
                setTimeout(() => setFeedback(null), 500);
            };

            const isMulti = mode === 'multi';
            const isWaiting = isMulti && status === 'waiting';

            if (isWaiting) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-4 text-center">
                         <div className="glass-panel p-10 rounded-3xl animate-pulse">
                            <h2 className="text-2xl font-bold text-gray-700 mb-4">‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô...</h2>
                            <p className="text-gray-500 mb-4">‡πÅ‡∏ä‡∏£‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô:</p>
                            <div className="bg-gray-100 p-4 rounded-xl text-4xl font-mono tracking-widest text-purple-600 select-all cursor-pointer" onClick={() => {
                                navigator.clipboard.writeText(roomId);
                                alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß!");
                            }}>
                                {roomId}
                            </div>
                            <button onClick={onQuit} className="mt-8 text-red-500 hover:underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                         </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col items-center min-h-screen bg-blue-50 pt-8 pb-4 px-4">
                    <div className="w-full max-w-lg flex justify-between items-center mb-8">
                        <button onClick={onQuit} className="w-10 h-10 rounded-full bg-white shadow text-gray-500 hover:text-red-500">
                            <i className="fa-solid fa-times"></i>
                        </button>
                        <div className="bg-white px-6 py-2 rounded-full shadow-sm">
                            <Timer duration={60} onTimeUp={timeUp} active={true} />
                        </div>
                        <div className="w-10"></div> 
                    </div>

                    <div className="w-full max-w-lg flex justify-between mb-8 gap-4">
                        <div className="flex-1 bg-white p-4 rounded-2xl shadow-sm border-l-4 border-blue-500 flex flex-col items-center">
                            <span className="text-gray-400 text-xs uppercase font-bold">‡∏Ñ‡∏∏‡∏ì</span>
                            <span className="text-4xl font-bold text-blue-600">{score}</span>
                        </div>
                        {isMulti && (
                            <div className="flex-1 bg-white p-4 rounded-2xl shadow-sm border-r-4 border-red-500 flex flex-col items-center">
                                <span className="text-gray-400 text-xs uppercase font-bold">‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á</span>
                                <span className="text-4xl font-bold text-red-600">{opponentScore}</span>
                            </div>
                        )}
                    </div>

                    <div className={`w-full max-w-lg glass-panel p-8 rounded-3xl text-center mb-6 shadow-xl relative overflow-hidden transition-transform ${feedback === 'wrong' ? 'shake bg-red-50' : ''}`}>
                        {feedback === 'correct' && (
                            <div className="absolute inset-0 flex items-center justify-center bg-green-100 bg-opacity-90 z-10 text-green-600 text-6xl font-bold anim-pop">
                                <i className="fa-solid fa-check"></i>
                            </div>
                        )}
                        
                        <div className="text-gray-400 text-sm mb-2">‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà {score + 1}</div>
                        <div className="text-6xl font-bold text-gray-800 mb-8 flex justify-center gap-4">
                            <span>{question.a}</span>
                            <span className="text-blue-500">{question.op === '*' ? '√ó' : question.op}</span>
                            <span>{question.b}</span>
                            <span className="text-gray-300">=</span>
                            <span className="text-blue-600">?</span>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <input
                                ref={inputRef}
                                type="number"
                                pattern="[0-9]*"
                                inputMode="numeric"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                className="w-full bg-gray-100 text-center text-4xl font-bold p-4 rounded-xl border-2 border-transparent focus:border-blue-500 focus:bg-white outline-none transition shadow-inner"
                                placeholder="‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö"
                            />
                            <button type="submit" className="hidden">Submit</button>
                        </form>
                    </div>

                    <div className="w-full max-w-lg grid grid-cols-3 gap-2 mt-auto">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'C', 0].map((num) => (
                            <button
                                key={num}
                                onClick={() => {
                                    if (num === 'C') setInput('');
                                    else setInput(prev => prev + num);
                                    inputRef.current?.focus();
                                }}
                                className={`p-4 rounded-xl font-bold text-2xl shadow-sm active:scale-95 transition ${num === 'C' ? 'bg-red-100 text-red-500' : 'bg-white text-gray-700 hover:bg-gray-50'}`}
                            >
                                {num}
                            </button>
                        ))}
                         <button
                            onClick={handleSubmit}
                            className="p-4 rounded-xl font-bold text-2xl shadow-sm active:scale-95 transition bg-blue-500 text-white"
                        >
                            <i className="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            );
        };

        const GameOver = ({ score, mode, onRestart, resultMessage, isNewHighScore }) => {
            const [aiAnalysis, setAiAnalysis] = useState('');
            const [loadingAi, setLoadingAi] = useState(false);

            const analyzePerformance = async () => {
                setLoadingAi(true);
                setAiAnalysis('');
                
                let context = `‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏Ñ‡∏¥‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ${score} ‡∏Ç‡πâ‡∏≠. `;
                if (score < 10) context += "‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°.";
                else if (score < 30) context += "‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏û‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ.";
                else context += "‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å ‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤!";

                const prompt = `${context} ‡∏ä‡πà‡∏ß‡∏¢‡∏û‡∏π‡∏î‡∏ß‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏™‡∏±‡πâ‡∏ô‡πÜ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ) ‡πÅ‡∏ö‡∏ö‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ç‡∏±‡∏ô ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢`;
                
                const response = await callGeminiAPI(prompt);
                setAiAnalysis(response);
                setLoadingAi(false);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 anim-pop">
                    <div className="glass-panel p-8 rounded-3xl text-center max-w-md w-full">
                        <div className="text-6xl mb-4 text-purple-500">
                            <i className="fa-solid fa-flag-checkered"></i>
                        </div>
                        <h2 className="text-3xl font-bold text-gray-800 mb-2">‡∏à‡∏ö‡πÄ‡∏Å‡∏°!</h2>
                        <div className="text-xl text-gray-600 mb-4">{resultMessage || "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß"}</div>
                        
                        {isNewHighScore && (
                            <div className="mb-4 text-yellow-500 font-bold animate-bounce">
                                <i className="fa-solid fa-star mr-1"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà!
                            </div>
                        )}

                        <div className="bg-gray-100 p-6 rounded-2xl mb-6">
                            <div className="text-gray-500 text-sm uppercase font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
                            <div className="text-6xl font-extrabold text-blue-600">{score}</div>
                        </div>

                        {/* Gemini Feature 2 */}
                        <div className="mb-6">
                             {!aiAnalysis && !loadingAi && (
                                <button 
                                    onClick={analyzePerformance}
                                    className="text-sm bg-gradient-to-r from-pink-500 to-rose-500 text-white py-2 px-4 rounded-full shadow hover:scale-105 transition flex items-center justify-center gap-2 mx-auto"
                                >
                                    <i className="fa-solid fa-wand-magic-sparkles"></i> ‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô
                                </button>
                             )}

                             {loadingAi && (
                                 <div className="text-gray-500 text-sm animate-pulse">
                                    <i className="fa-solid fa-robot mr-2"></i> AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏Ñ‡∏°...
                                 </div>
                             )}

                             {aiAnalysis && (
                                <div className="bg-white p-4 rounded-xl border-l-4 border-pink-500 text-left shadow-sm">
                                    <div className="text-xs text-pink-500 font-bold mb-1">COACH GEMINI SAYS:</div>
                                    <div className="text-gray-700 text-sm typing-cursor" dangerouslySetInnerHTML={{__html: marked.parse(aiAnalysis)}}></div>
                                </div>
                             )}
                        </div>

                        <button 
                            onClick={onRestart}
                            className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition hover:scale-105"
                        >
                            ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                        </button>
                    </div>
                </div>
            );
        };

        // --- Main App ---

        const App = () => {
            const [user, setUser] = useState(null);
            const [authChecked, setAuthChecked] = useState(false);
            const [gameState, setGameState] = useState('loading'); // loading, login, menu, lobby, leaderboard, playing_single, playing_multi, game_over
            const [score, setScore] = useState(0);
            const [opponentScore, setOpponentScore] = useState(0);
            const [question, setQuestion] = useState(generateQuestion());
            const [roomId, setRoomId] = useState(null);
            const [gameResultMsg, setGameResultMsg] = useState('');
            const [firestoreUnsubscribe, setFirestoreUnsubscribe] = useState(null);
            const [playerRole, setPlayerRole] = useState(null);
            const [isNewHighScore, setIsNewHighScore] = useState(false);

            // Auth State Listener
            useEffect(() => {
                if (isFirebaseReady) {
                    const unsub = auth.onAuthStateChanged(u => {
                        setUser(u);
                        setAuthChecked(true);
                        if (u) {
                            if (gameState === 'login' || gameState === 'loading') {
                                setGameState('menu');
                            }
                        } else {
                            // Only force login screen if NOT already in an interactive state set by manual login
                            // This check prevents auth listener from overriding manual "admin" login immediately
                            // But since manual login happens AFTER this listener triggers initially, we just need to handle the update carefully.
                            // Actually simpler: if user is null from firebase, we just go to login. 
                            // Manual login sets local state `user` but firebase `user` is still null.
                            // We need to bypass this logic if we have a manual user.
                        }
                    });
                    return () => unsub();
                } else {
                    setAuthChecked(true);
                    setGameState('login'); 
                }
            }, [isFirebaseReady]);
            
            // Effect to manage navigation based on user state changes (both firebase and manual)
            useEffect(() => {
                if (user) {
                     if (gameState === 'login' || gameState === 'loading') {
                        setGameState('menu');
                    }
                } else if (authChecked && !user) {
                    setGameState('login');
                }
            }, [user, authChecked]);


            // Auto Login for Preview (Dev Only)
            useEffect(() => {
                const autoLogin = async () => {
                   if (isFirebaseReady && !auth.currentUser && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                       try {
                           await auth.signInWithCustomToken(__initial_auth_token);
                       } catch (e) { console.error("Auto login failed", e); }
                   }
                };
                autoLogin();
            }, []);

            const handleManualLogin = (mockUser) => {
                setUser(mockUser);
                setGameState('menu');
            };

            const startGameSingle = () => {
                setScore(0);
                setIsNewHighScore(false);
                setQuestion(generateQuestion());
                setGameState('playing_single');
            };

            const handleLogout = async () => {
                // Only try to sign out of Firebase if we are actually signed in to Firebase
                if (auth && auth.currentUser) await auth.signOut();
                setUser(null);
                setGameState('login');
            };

            const updateAnswer = (isCorrect) => {
                if (isCorrect) {
                    const newScore = score + 1;
                    setScore(newScore);
                    setQuestion(generateQuestion());
                    
                    if (gameState === 'playing_multi' && roomId && user) {
                        updateMultiScore(newScore);
                    }
                }
            };

            const updateMultiScore = (newScore) => {
                if (!roomId || !playerRole) return;
                const field = playerRole === 'player1' ? 'player1.score' : 'player2.score';
                db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomId).update({
                    [field]: newScore
                });
            };

            const saveHighScore = async (finalScore) => {
                if (!isFirebaseReady || !user) return;
                // Don't save for demo user
                if (user.uid === 'admin-demo-uid') return;

                try {
                    const username = user.displayName || user.email.split('@')[0];
                    const scoreRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('scores').doc(user.uid);
                    
                    const doc = await scoreRef.get();
                    let currentHigh = 0;
                    if (doc.exists) {
                        currentHigh = doc.data().score || 0;
                    }

                    if (finalScore > currentHigh) {
                        await scoreRef.set({
                            username: username,
                            score: finalScore,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setIsNewHighScore(true);
                    }
                } catch (e) {
                    console.error("Error saving score:", e);
                }
            };

            const handleGameOver = async () => {
                let msg = "";
                if (gameState === 'playing_multi') {
                    if (score > opponentScore) msg = "‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏ô‡∏∞! üéâ";
                    else if (score < opponentScore) msg = "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ! üò¢";
                    else msg = "‡πÄ‡∏™‡∏°‡∏≠!";
                    if (firestoreUnsubscribe) firestoreUnsubscribe();
                } else if (gameState === 'playing_single') {
                    await saveHighScore(score);
                }
                
                setGameResultMsg(msg);
                setGameState('game_over');
            };

            // Multiplayer Logic
            const handleJoinRoomV2 = async (name, inputRoomId, type) => {
                 if (!isFirebaseReady || !user) return;
                 const roomsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms');
                 
                 // Update display name if simple email login (Skip for demo user)
                 if (user.uid !== 'admin-demo-uid' && !user.displayName) {
                     await user.updateProfile({ displayName: name });
                 }

                 try {
                     if (type === 'create') {
                         const res = await roomsRef.add({
                             player1: { id: user.uid, name, score: 0 },
                             status: 'waiting',
                             createdAt: firebase.firestore.FieldValue.serverTimestamp()
                         });
                         setRoomId(res.id);
                         setPlayerRole('player1');
                         listenToRoom(res.id, 'player1');
                         setGameState('playing_multi');
                     } else {
                         const roomDoc = await roomsRef.doc(inputRoomId).get();
                         if (!roomDoc.exists) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ"); return; }
                         if (roomDoc.data().status !== 'waiting') { alert("‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß"); return; }

                         await roomsRef.doc(inputRoomId).update({
                             player2: { id: user.uid, name, score: 0 },
                             status: 'playing'
                         });
                         setRoomId(inputRoomId);
                         setPlayerRole('player2');
                         listenToRoom(inputRoomId, 'player2');
                     }
                 } catch (e) { console.error(e); alert("Error connecting."); }
            };

            const listenToRoom = (rId, role) => {
                const roomRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(rId);
                const unsub = roomRef.onSnapshot(doc => {
                    const data = doc.data();
                    if (!data) return;
                    if (data.status === 'playing' && gameState !== 'playing_multi') {
                         // Ensure we are in playing state visually
                    }
                    if (role === 'player1') {
                        if (data.player2) setOpponentScore(data.player2.score);
                    } else {
                        if (data.player1) setOpponentScore(data.player1.score);
                    }
                }, error => console.log(error));
                setFirestoreUnsubscribe(() => unsub);
            };

            const resetGame = () => {
                setGameState('menu');
                setRoomId(null);
                setScore(0);
                setOpponentScore(0);
                setPlayerRole(null);
                setIsNewHighScore(false);
                if (firestoreUnsubscribe) firestoreUnsubscribe();
            };

            if (!authChecked) {
                return <div className="min-h-screen flex items-center justify-center text-gray-500">Loading...</div>;
            }

            return (
                <div className="min-h-screen">
                    {gameState === 'login' && (
                        <LoginScreen onManualLogin={handleManualLogin} />
                    )}

                    {gameState === 'menu' && (
                        <MainMenu 
                            onStartSingle={startGameSingle} 
                            onStartMulti={() => setGameState('lobby')}
                            onShowLeaderboard={() => setGameState('leaderboard')}
                            onLogout={handleLogout}
                            canPlayOnline={isFirebaseReady}
                            username={user?.displayName || user?.email?.split('@')[0]}
                        />
                    )}

                    {gameState === 'leaderboard' && (
                        <Leaderboard 
                            onBack={() => setGameState('menu')}
                            currentUser={user}
                        />
                    )}

                    {gameState === 'lobby' && (
                        <Lobby 
                            onJoinRoom={handleJoinRoomV2} 
                            onBack={() => setGameState('menu')}
                            currentUser={user}
                        />
                    )}

                    {(gameState === 'playing_single' || gameState === 'playing_multi') && (
                        <GameScreen 
                            mode={gameState === 'playing_single' ? 'single' : 'multi'}
                            question={question}
                            score={score}
                            opponentScore={opponentScore}
                            onAnswer={updateAnswer}
                            onQuit={resetGame}
                            timeUp={handleGameOver}
                            roomId={roomId}
                            status={gameState === 'playing_multi' && playerRole === 'player1' && opponentScore === 0 ? 'waiting' : 'playing'}
                        />
                    )}

                    {gameState === 'game_over' && (
                        <GameOver 
                            score={score} 
                            resultMessage={gameResultMsg}
                            onRestart={resetGame}
                            isNewHighScore={isNewHighScore}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
